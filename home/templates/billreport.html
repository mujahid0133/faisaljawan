<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invoice Bill Report</title>
    <link rel="stylesheet" href="/static/css/main.css" />
    <style>
      /* --- Copy of index.html CSS for formatting --- */
      * {
        box-sizing: border-box;
      }
      body {
        font-size: 14px;
        font-family: "Segoe UI", Arial, Helvetica, sans-serif;
        color: #222;
        background: #f8fafd;
      }
      html,
      body {
        width: 210mm;
        height: 297mm;
        margin: 0;
        padding: 0;
        background: #f8fafd;
      }
      .invoice-a4 {
        width: 190mm;
        min-height: 277mm;
        margin: 0 auto;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 32px 0 rgba(0, 0, 0, 0.1);
        padding: 24px 12px;
        position: relative;
        overflow: hidden;
      }
      .company-title {
        text-align: center;
        font-size: 2.3em;
        font-weight: 800;
        letter-spacing: 1.5px;
        margin-bottom: 0.1em;
        margin-top: 32px;
        text-transform: uppercase;
        color: #1a237e;
      }
      .subtitle {
        text-align: center;
        font-size: 1.1em;
        font-weight: bold;
        background: #222;
        color: #fff;
        display: inline-block;
        padding: 3px 22px;
        border-radius: 4px;
        margin-bottom: 0.3em;
        margin-left: 50%;
        transform: translateX(-50%);
        letter-spacing: 0.5px;
        box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.08);
      }
      .bill-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 2em;
        background: #fff;
        box-shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.04);
      }
      .bill-table th,
      .bill-table td {
        border: 1px solid #e0e0e0;
        padding: 8px 10px;
        font-size: 1em;
        text-align: center;
      }
      .bill-table th {
        background: #e3eafc;
        font-weight: bold;
        color: #1a237e;
        font-size: 1.05em;
      }
      .bill-table .desc {
        text-align: left;
        font-size: 0.98em;
      }
      .bill-table .total-row td {
        font-weight: bold;
        background: #e3eafc;
        color: #1a237e;
      }
      .footer-note {
        margin-top: 2em;
        font-size: 0.95em;
        color: #222;
        text-align: left;
      }
      @media print {
        html,
        body {
          width: 210mm;
          height: 297mm;
        }
        .invoice-a4 {
          width: 190mm;
          min-height: 277mm;
          box-shadow: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="invoice-a4" id="billreport-content">
      <a
        href="/admin/home/invoice/"
        id="back-admin-btn"
        style="
          position: absolute;
          top: 20px;
          right: 170px;
          z-index: 1000;
          padding: 8px 18px;
          font-size: 1em;
          background: #607d8b;
          color: #fff;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          text-decoration: none;
        "
      >
        Back to Admin
      </a>
      <button
        id="download-pdf-btn"
        style="
          position: absolute;
          top: 20px;
          right: 30px;
          z-index: 1000;
          padding: 8px 18px;
          font-size: 1em;
          background: #1a237e;
          color: #fff;
          border: none;
          border-radius: 5px;
          cursor: pointer;
        "
      >
        Download PDF
      </button>
      <div class="company-title" style="margin-top: 50px">M. FAZAL ELLAHI &amp; SONS</div>
      <div class="subtitle">AUTOMOBILE ENGINEER</div>
      <h2 style="text-align: center; margin-top: 1em">
        All Invoices Bill Report
      </h2>
      <div style="display: flex; flex-direction: row-reverse; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span >
    <span style="color: #1a237e; font-weight: bold;">Date: </span><span>{{ current_date|date:"d-m-Y" }}</span>
  </span>
  {% if single_customer_name %}
    <span class="customer-name">
      <span style="color: #1a237e; font-weight: bold">Customer:&nbsp;</span> {{ single_customer_name }}
    </span>
  {% endif %}
  
</div>
      <table class="bill-table">
        <thead>
          <tr>
            <th>No.</th>
            <th>Invoice #</th>
            <th>FBR&nbsp;Invoice #</th>
            <th>PRA&nbsp;Invoice #</th>
            <th>Date</th>
            {% comment %}
            <th>Customer</th>
            {% endcomment %}
            <th>Vehicle</th>
            {% comment %}
            <th>Status</th>
            {% endcomment %}
            <th>Total (Incl. Tax)</th>
            {% comment %}
            <th>Items</th>
            {% endcomment %}
          </tr>
        </thead>
        <tbody>
          {% for invoice in invoices %}

          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ invoice.invoice_no }}</td>
            <td>
              {% if invoice.has_goods %} F-{{ invoice.invoice_no }} {% else %} -
              {% endif %}
            </td>
            <td>
              {% if invoice.has_services %} P-{{ invoice.invoice_no }} {% else %} - {% endif %}
            </td>
            <td>{{ invoice.date|date:"d-m-Y" }}</td>
            {% comment %}
            <td>{{ invoice.customer.name }}</td>
            {% endcomment %}
            <td>{{ invoice.vehicle.number }}</td>
            {% comment %}
            <td>{{ invoice.status|title }}</td>
            {% endcomment %}
            <td>{{ invoice.total_incl_tax|floatformat:2 }}</td>
            {% comment %}
            <td>
              <table style="width: 100%; border: none; background: none">
                <thead>
                  <tr>
                    <th style="font-size: 0.95em">Product</th>
                    <th style="font-size: 0.95em">Qty</th>
                    <th style="font-size: 0.95em">Unit Price</th>
                    <th style="font-size: 0.95em">Total (excl. tax)</th>
                    <th style="font-size: 0.95em">Tax</th>
                    <th style="font-size: 0.95em">Total Tax</th>
                    <th style="font-size: 0.95em">Total (incl. tax)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in invoice.items.all %}
                  <tr>
                    <td class="desc">{{ item.product.name }}</td>
                    <td>{{ item.qty }}</td>
                    <td>
                      {% if item.qty %}{{
                      item.price_excl_tax|div:item.qty|floatformat:2 }}{% else
                      %}0.00{% endif %}
                    </td>
                    <td>{{ item.price_excl_tax|floatformat:2 }}</td>
                    <td>
                      {% if item.category %}{{ item.category.rate|floatformat:0
                      }}%{% else %}-{% endif %}
                    </td>
                    <td>{{ item.tax_amount|floatformat:2 }}</td>
                    <td>{{ item.price_incl_tax|floatformat:2 }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </td>
            {% endcomment %}
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" style="text-align: center">No invoices found.</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="6" style="text-align: right; font-weight: bold">
              Grand Total
            </td>
            <td style="font-weight: bold">{{ grand_total|floatformat:2 }}</td>
          </tr>
        </tfoot>
      </table>
      <div class="footer-note">
        Please arrange payment through crossed cheque.
      </div>
    </div>
    <!-- html2pdf.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
      // Hide button in print
      const style = document.createElement("style");
      style.innerHTML = `@media print { #download-pdf-btn, #back-admin-btn { display: none !important; } }`;
      document.head.appendChild(style);
      // Download PDF button handler
      document
        .getElementById("download-pdf-btn")
        .addEventListener("click", function () {
          // Use current date for filename
          const now = new Date();
          const y = now.getFullYear();
          const m = String(now.getMonth() + 1).padStart(2, "0");
          const d = String(now.getDate()).padStart(2, "0");
          let filename = `BillReport_${y}${m}${d}.pdf`;
          // Hide the button before generating PDF
          const btn = document.getElementById("download-pdf-btn");
          btn.style.display = "none";
          const backBtn = document.getElementById("back-admin-btn");
          backBtn.style.display = "none";
          // Generate PDF
          html2pdf()
            .set({
              margin: 0,
              filename: filename,
              image: { type: "jpeg", quality: 0.98 },
              html2canvas: { scale: 2, useCORS: true },
              jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
              pagebreak: { mode: ["avoid-all", "css", "legacy"] },
            })
            .from(document.getElementById("billreport-content"))
            .save()
            .then(() => {
              btn.style.display = "";
              backBtn.style.display = "";
            });
        });
    </script>
  </body>
</html>
